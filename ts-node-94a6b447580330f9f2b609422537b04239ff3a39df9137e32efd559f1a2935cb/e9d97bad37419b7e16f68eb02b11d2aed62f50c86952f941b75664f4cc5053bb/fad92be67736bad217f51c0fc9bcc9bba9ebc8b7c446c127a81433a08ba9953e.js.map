{"version":3,"file":"/home/lithos/Data/Lab/codash/angularSpa/src/app/app.component.ts","sources":["/home/lithos/Data/Lab/codash/angularSpa/src/app/app.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component,ViewEncapsulation, OnInit } from '@angular/core';\nimport { RouterModule, Router } from '@angular/router';\nimport { Title } from '@angular/platform-browser';\nimport { UserService } from './user/service/user.service';\nimport './rxjs-operators';\nimport\t{Observable}\tfrom\t'rxjs/Observable';\n\n\n\n@Component({\n  selector: 'my-app',\n  templateUrl:'./app.component.html',\n  styleUrls : ['./app.component.css'],\n  encapsulation: ViewEncapsulation.None\n})\nexport class AppComponent implements OnInit{\n   user ;\n   timerSub ;\n   request : boolean;\n   api_server_error : boolean;\n   public constructor(private titleService: Title, private userService : UserService, public router: Router ) {}\n\n  ngOnInit(){\n      this.request = false;\n      this.setTitle(\"Acceuil\");\n      this.getInitialUser();\n  }\n\n    public setTitle( newTitle: string) {\n      this.titleService.setTitle(newTitle);\n    }\n\n    public getInitialUser(){\n\n        if(localStorage.getItem(\"new_token\")){\n          this.refreshToken();   \n        }else{\n          this.userService.getUserSession().subscribe(\n            data =>{\n              this.user = data;\n              if(this.user.compte_state == false) this.router.navigate(['/user/r/step2']);\n              this.request = true;\n              localStorage.setItem(\"request\",\"true\");\n              localStorage.setItem('user_id',this.user.id);\n              this.subscribeToData();\n            },\n            error => {\n                  this.request = true;\n                  localStorage.setItem(\"request\",\"true\");\n                   switch (error.status) {\n                     case 401:\n                           console.log('token expired')\n                           this.refreshToken();\n                       break;\n                     case 403: \n                        console.log(\"Visiteur\");  \n                       break;\n                     case 0 :\n                        this.api_server_error = true;\n                       break;\n                     default:\n                        localStorage.clear();\n                        localStorage.setItem(\"authent\" , \"N\");\n                       break;\n                   }\n                   \n            },\n            () =>{\n              this.request = true;\n              localStorage.setItem(\"request\",\"true\");\n              console.log(\"finish\");\n            } \n        );\n\n        }\n        \n  }\n\n  //verify user session very time\n  private subscribeToData(): void {\n      if(localStorage.getItem(\"authent\") == \"O\")\n      {\n          this.timerSub = Observable.timer(10000).subscribe(\n            () => {\n              this.getInitialUser();\n            }\n          );\n\n      }\n  }\n \n  //refreshToken and reaload page\n  public refreshToken()\n  {\n    this.request = true;\n    localStorage.setItem('new_token','true');\n    this.userService.getRefreshToken().subscribe(\n        data => {\n          \n          localStorage.setItem(\"authent\" , \"O\");\n          localStorage.setItem(\"access_token\" , data.access_token);\n          localStorage.setItem(\"expires_in\" , data.expires_in);\n          localStorage.setItem(\"token_type\" , data.token_type);\n          localStorage.setItem(\"refresh_token\" , data.refresh_token);\n          localStorage.removeItem(\"new_token\");\n\n          this.userService.isLoggedIn = true;\n          if (this.userService.isLoggedIn) {\n             let redirect = this.userService.redirectUrl ? this.userService.redirectUrl : '/';\n             this.router.navigate([redirect]);\n           }\n          window.location.reload();\n          \n        },\n        error =>{\n          localStorage.clear();\n          window.location.reload();\n          console.log(error);\n        },\n        () => console.log(\"finish\")\n    );\n  }\n}\n"]}
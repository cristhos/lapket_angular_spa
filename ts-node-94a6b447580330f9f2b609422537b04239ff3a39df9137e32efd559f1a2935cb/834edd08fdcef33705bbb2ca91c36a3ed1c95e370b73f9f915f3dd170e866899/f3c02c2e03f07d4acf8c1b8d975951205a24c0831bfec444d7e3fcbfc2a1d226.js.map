{"version":3,"file":"/home/lithos/Data/Lab/codash/angularSpa/src/app/deal/list/deal-message.component.ts","sources":["/home/lithos/Data/Lab/codash/angularSpa/src/app/deal/list/deal-message.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, OnInit, OnDestroy} from '@angular/core';\nimport { ActivatedRoute } from '@angular/router';\nimport\t{Observable}\tfrom\t'rxjs/Observable';\n\nimport { DealService } from '../../deal/service/deal.service';\n\ndeclare var $: any\n\n\n@Component({\n  selector: 'deal-message',\n  templateUrl: './deal-message.component.html',\n  styles: [`\n      #message-list-auto{\n        height: 20rem;\n        overflow-y: scroll;\n      }\n      .conversation-list-auto{\n        height: 35rem;\n        overflow-y: scroll;\n      }\n  `],\n})\n\nexport class DealMessageComponent implements OnInit, OnDestroy{\n  dealMessages : any = [];\n  DealMessagesLoading : boolean;\n  dealConversation;\n  dealConversations : any = [];\n  dealConversationsLoading:boolean;\n  pages: number;\n  page : number;\n  conversationPages:number;\n  conversationPage:number;\n  sub;\n  timerSub;\n  timerSubLoad = false;\n  constructor(private dealService : DealService,private route: ActivatedRoute){}\n\n  ngOnInit(){\n    this.page = 1;\n    this.pages = 2;\n    this.conversationPage = 1;\n    this.conversationPages = 2;\n    this.getDealMyConversations();\n    this.getInitMessages();\n  }\n  ngOnDestroy() {\n    this.sub.unsubscribe();\n    this.timerSub.unsubscribe();\n  }\n\n  getInitMessages(){\n    this.sub = this.route.params.subscribe(params => {\n      let conversation_id = +params['conversation_id'];\n      this.getLastDealMessages(conversation_id);\n    });\n    this.scrollMessageDown();\n  }\n \n\n  \n  //get PaginateMessage\n  getDealMessages(){\n    this.sub = this.route.params.subscribe(params => {\n      let conversation_id = +params['conversation_id'];\n      \n      if(this.timerSubLoad) this.timerSub.unsubscribe();\n      this.getDealConversation(conversation_id);\n       if(this.page <= this.pages ){\n          this.dealService.getDealMessages(conversation_id, this.page).subscribe(\n            data =>{\n                this.scrollMessageUp();\n                this.checkMessages(data,'old');\n            },\n            error =>{\n              console.log(error)\n            },\n            () =>{\n              console.log(\"finish\")\n            }\n          );\n       }\n\n    });\n  }\n  \n  //get last message in my api page=1 order by desc\n  getLastDealMessages(conversation_id){\n      if(this.timerSubLoad) this.timerSub.unsubscribe();\n\n      this.getDealConversation(conversation_id);\n\n      this.dealService.getDealMessages(conversation_id, 1).subscribe(\n            data =>{\n                this.dealMessages = [];\n                this.checkMessages(data,\"last\");\n                this.subscribeToData(conversation_id);\n            },\n            error =>{\n              console.log(error)\n            },\n            () =>{\n              console.log(\"finish\")\n            }\n          );\n  }\n  \n  //add message if not exist in array() call realtime subscribe\n  checkMessages(data,checkType){\n    this.pages = data.pages;\n    \n    for(let i=0;i<data.limit;i++){\n      if(data._embedded.items[i]){\n        let pass = true;\n        if(this.dealMessages.length >0){\n            for(let j=0;j<this.dealMessages.length;j++){\n              if(data._embedded.items[i].id == this.dealMessages[j].id){\n                pass = false;\n                break;\n              } \n           }\n        }\n        \n        if(pass ==true){\n          if(checkType==\"last\"){\n            this.dealMessages.unshift(data._embedded.items[i]);\n          }else{\n            this.dealMessages.unshift(data._embedded.items[i]);\n          }\n        }\n        this.page = data.page + 1;       \n      }\n    }\n\n  }\n\n  scrollMessageDown(){\n      let d = document,mla;\n      mla = d.getElementById('message-list-auto');\n      mla.scrollTop = mla.scrollHeight;\n  }\n  scrollMessageUp(){\n      let d = document,mla;\n      mla = d.getElementById('message-list-auto');     \n      mla.scrollTop = 0;\n  }\n\n  getDealConversation(conversation_id){\n    this.dealService.getDealConversation(conversation_id).subscribe(\n        data =>{\n           this.dealConversation = data;\n        },\n        error =>{\n          console.log(error)\n        } ,\n        () =>{\n          console.log(\"finish\")\n        }\n    );\n  }\n\n  getDealMyConversations(){\n      if(this.conversationPage <= this.conversationPages ){\n          this.dealService.getMyDealConversations(this.conversationPage).subscribe(\n          data => {\n            this.conversationPages = data.pages;\n                for(let i=0; i<=data.limit; i++) {\n                  if(data._embedded.items[i]){\n                    this.dealConversations.push(data._embedded.items[i]);\n                    this.conversationPage = data.page + 1;\n                  }\n                }\n          },\n          error => console.log(error),\n          () => console.log(\"finish\")\n        );\n      }\n  }\n\n  private subscribeToData(conversation_id): void {\n    this.timerSub = Observable.timer(5000).subscribe(\n      () => {\n            this.timerSubLoad = true;\n            this.page = 1;\n            this.pages = 2;\n            this.getLastDealMessages(conversation_id);\n      }\n    );\n  }\n  \n  //get last deal message\n  onScrollUpMessages(){\n    this.getDealMessages();\n  }\n  onScrollDownConversations(){\n    this.getDealMyConversations();\n  }\n}\n"]}